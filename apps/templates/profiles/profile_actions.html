{% extends "layouts/base.html" %}

{% block title %} متابعة تأسيس الجهات {% endblock %} 
{% block header_title %} متابعة تأسيس الجهات {% endblock %}
{% block header_profile_image %}
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.-->
    <path d="M616 192H480V24c0-13.3-10.7-24-24-24H312c-13.3 0-24 10.7-24 24v72h-64V16c0-8.8-7.2-16-16-16h-16c-8.8 0-16 7.2-16 16v80h-64V16c0-8.8-7.2-16-16-16H80c-8.8 0-16 7.2-16 16v80H24c-13.3 0-24 10.7-24 24v360c0 17.7 14.3 32 32 32h576c17.7 0 32-14.3 32-32V216c0-13.3-10.8-24-24-24zM128 404c0 6.6-5.4 12-12 12H76c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40zm0-96c0 6.6-5.4 12-12 12H76c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40zm0-96c0 6.6-5.4 12-12 12H76c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40zm128 192c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40zm0-96c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40zm0-96c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40zm160 96c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40zm0-96c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40zm0-96c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12V76c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40zm160 288c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40zm0-96c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40z" />
</svg>
{% endblock %}


<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

    <main>
        
        {% include 'includes/preloader.html' %}

        <section class="section section-md">
            <div class="container">
                <div class="profile-header-flex">
                    <div class="profile-name">
                        <p><label for="profile_name">إسم الجهة:</label> {{profile.name}}</p>
                    </div>

                    <div class="profile-prop">
                        <div class="profile-est">
                            {% if profile_actions %}
                            <p><label for="profile_name">حالة التأسيس:</label> {{ profile_actions[-1].action.establishment }}</p>
                            {% else %}
                            <p><label for="profile_name">حالة التأسيس:</label> غير محددة</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="profile-alert">
                        <p><label for="profile_name">التنبيه الأحدث:</label> {{ profile.alert }}</p>
                    </div>
                 </div>
                <br>                
                <h3 style="border-bottom: 3px double #000;">الأحداث المقترنة</h3>
                <form class="form-inline" action="{{ url_for('profiles_blueprint.profile_actions', profile_id=profile.id) }}" method="post">
                    {{ form.hidden_tag() }}
                    <label for="action_id" style="min-width: fit-content;">حدث جديد</label>
                    {{ form.action_id(class="form-control") }}
                    <label for="notes" style="min-width: fit-content;">ملاحظات</label>
                    {{ form.notes(class="form-control") }}
                    {{ form.submit(class="btn btn-primary") }}
                </form>

                {% if profile_actions %}
                <button onclick="exportTableToExcel()" class="btn" style="font-family: 'Jersey 10'; font-size: x-large;"><span class="fas fa-file-excel" style="font-size: x-large; padding-inline: 5px; color: green;"></span>Export to Excel</button>
                <div class="table-container">
                    <table class="table table-hover" id="myTable">
                        <thead>
                        <tr>
                            <th>الحدث</th>
                            <th>تاريخ الإضافة</th>
                            <th>وقت الإضافة</th>
                            <th>المستخدم</th>
                            <th>الوقت قبل التنبيه</th>
                            <th>ملاحظات</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody>                
                        {% for profile_action in profile_actions %}
                        <tr>
                            <td>{{ profile_action.action.name }}</td>
                            <td>{{ profile_action.creation_date }}</td>
                            <td>{{ profile_action.creation_time }}</td>
                            <td>{{ profile_action.creator.username }}</td>
                            <td>
                                {% if profile_action.rem_days <= 0 %}
                                    <p class="btn-danger">{{ profile_action.action.alert }}</p>
                                {% else %}
                                    {{ profile_action.rem_days }}
                                {% endif %}
                            </td>
                            <td>{{ profile_action.notes }}</td>
                            <td>
                                <div class="btn-bar">
                                    <a class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modal-default" onclick="openConfirmationModal('هل أنت متأكد من الحذف ؟','{{ url_for('profiles_blueprint.delete_profile_action', profile_action_id=profile_action.id) }}');">حذف</a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                لا يوجد أي إجراءات مقترنة
                {% endif %}
            </div>
        </section>

        <section class="section section-md">
        </section>

    </main>

    {% include 'includes/footer.html' %}

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/file-saver"></script>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/tableexport.jquery.plugin/tableexport.min.js"></script>
<script>
    function exportTableToExcel() {
        var wb = XLSX.utils.table_to_book(document.getElementById('myTable'), { sheet: "Sheet 1" });
        var wbout = XLSX.write(wb, { bookType: 'xlsx', bookSST: true, type: 'binary' });
        saveAs(new Blob([s2ab(wbout)], { type: "application/octet-stream" }), 'table.xlsx');
    }

    function s2ab(s) {
        var buf = new ArrayBuffer(s.length);
        var view = new Uint8Array(buf);
        for (var i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }
</script>
{% endblock javascripts %}
